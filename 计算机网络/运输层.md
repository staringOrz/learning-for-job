运输层

运输层向上面的应用层提供通讯服务，他属于面向通信部分的最高层，同时也是用户功能的最低层

运输层向高层网络屏蔽了下面网络核心的细节，他使得应用进程看见的就好像在两个运输层实体之间有一个端对端的逻辑通信。

## 运输层的两个最要协议

1. 用户数据报协议UDP
2. 传输控制协议TCP

![1531874107512](E:\mydairy\计算机网络\运输协议.png)

在运输层中，应用进程的标识通过协议端口号标识，即端口，通过IP+端口可以确定某一主机的应用进程

![1531874248170](E:\mydairy\计算机网络\端口.png)

## UDP的主要特点

1. **UDP是无连接的**。即发送数据之前无需建立连接，因此减少了连接的开销个发送的时延
2. **UDP是尽最大努力交付的**，即不保证可靠交付，因此主机不需要维持复杂的连接状态表
3. **UDP是面向报文的**。发送方的UDP对应用程序交下来的报文，在添加首部后就向下交付IP。UDP对应用成交下来的报文，即不合并也不拆分，而是保留这些报文的边界。即UDP一次交付一个完整的报文，因此，应用程序必须选择合适发小的报文。若报文太长，UDP把他交给IP层后，IP层在传送时可能要进行分片，这降低IP层的效率。
4. **UDP没有拥塞控制**。因此网络出现的拥塞不会使主机发送速率降低。这对某些实时应用是很重要的。
5. UDP支持一对一，一对多，多对一，多对多的交互通信。
6. UDP首部开销小，只有8字节。比TCP的20个字节的首部要短。

## UDP的首部格式

![1531875009883](E:\mydairy\计算机网络\UDP格式.png)

1. 源端口 源端口，在需要对方回信时选用。不需要时 用全0
2. 目的端口 目的端口，这在终点交付报文时必须要使用到
3. 长度  UDP用户数据报的长度，其最小值是8（仅有首部）
4. 检验和 检验UDP用户数据报在传输中是否有错，有错就丢失

UDP用户数据报首部的计算方式有些特殊。在计算检验和时，要在UDP用户数据报之前增加12个字节的伪首部。只在计算检验和时临时添加，伪首部既不向下传输也不向上递交。

![1531876463929](E:\mydairy\计算机网络\UDP伪首部.png)

## 传输控制协议TCP

## TCP主要特点

1. **面向连接的运输层协议。**
2. **每一条TCP连接只能是两个端点**，每一条TCP连接只能是点对点的
3. **TCP提供可靠交付服务**。通过TCP连接传送的数据，无差错、不丢失、不重复、并且按序到达。
4. **TCP提供全双工通信**  TCP允许通信双方的应用进程在任何时候都能发送数据。TCP连接的两端都设有发送缓存和结束缓存，用来临时存放双向通信的数据
5. **面向字节流** 。 TCP的“流”指的是流入到进程或者进程流出的字节序列。"面向字节流"的含义是：虽然应用进程和TCP的交互是一次一个数据块（大小不等），但是TCP把应用进程交下来的数据仅仅看成是一连串的无结构的字节流。TCP并不知道所传送的字节流含义。

每一条TCP连接有两个端点，TCP连接的端点叫套接字或插口。端口号拼接到IP地址即构成套接字

![1531877968132](E:\mydairy\计算机网络\套接字.png)

## 停止等待协议

可靠性传输原理

**停止等待**：就是每次发送完一个分组就停止发送，等待对方确认，在收到确认后再发送下一个分组

每一个发送方，发送完一个分组就会设置一个超时计数器，一旦出现差错，在规定时间内没有收到确认报文，就会超时重传。如果收到就撤销已经设置的计时器

## 对于确认分组丢失和迟到

1. 丢弃这个重复的分组，不向上层交付。
2. 向A发送确认。告诉A已经收到了。
3. 对于另一方收到重复的确认处理很简单，就是收下并丢弃。

以上就可以在不可靠的传输网络上实现可靠的通信。

停止等待协议的缺点是信道利用率不高，为了提高传输效率，发送方可以不使用底效率的停止等待协议，而是采用流水线传输。流水线传输就是发送方可连续发送多个分组，不必没发送完一个分组就停顿下来等待对方确认。这样就可以不间断地发送数据。这种传输方式可以获得很高的信道利用率

![1531879389513](E:\mydairy\计算机网络\流水线传输.png)

使用上述流水线传输方法时，要使用到连续ARQ协议和滑动窗口协议

## 连续ARQ协议

- 连续ARQ协议规定，发送方没收到一个确认，就把发送窗口向前获得一个分组单位。
- 接收方一般都采用累积确认的方式，这就是说，接收方不必对收到的分组逐个发送确认，而是在收到几个分组后，对按序到达的最后一个分组发送确认，这就表示到这个分组为止的所有分组都已经正确收到了。

**累积确认优点：容易实现，即使确认丢失也不必重传**。

累积确认缺点：不能向发送方反应出接收方已经正确收到的所有分组的信息。

## TCP报文格式

![1531880346312](E:\mydairy\计算机网络\TCP报文格式.png)

1. **源端口和目的端口** 。各占2个字节
2. **序号**。占4字节，序号范围[0，2^32-1] ,共2^32（即4294967296）个序号。序号增加到最大值后下一个序号又回到0.TCP是面向字节流的。在一个TCP连接中传送的字节流中的每一个字节都是按顺序编号。整个要传送的字节流的起始序号必须在连接建立时设置。首部中的字段值则是本报文所发送的数据的第一个字节的序号。这个字段的名称叫“报文段序号”
3. **确认号**。 占4字节，是期望收到对方下一个报文段的第一个数据字节的序号。
4. **数据偏移**。 占4个字节 他指出TCP报文段的数据起始处距离TCP报文段的起始处有多远。这个字段实际上指出TCP报文段的首部长度。
5. **保留**。 占6字节，保留为今后使用吗，但目前为0
6. **紧急URG** 但URG=1时，表明紧急指针字段有效。他高手系统此报文段中有紧急数据，应到尽快传送。而不是按原来的排队顺序来传送
7. **确认ACK**，仅当ACK=1时，确认号字段才有效。，TCP规定，在连接建立后所有传送的报文都必须把ACK置1
8. **推送PSH** 但两个应用进程进行交互式通信时，有时在一段的应用进程希望在键入一个命令后立即收到对方的相应。当发送方TCP把PSH置1，立即创建一个报文段发送出去，结束方收到PSH的报文段时，就尽快地交付到应用进程，而不是等整个接收缓存区填满了才向上交付
9. **复位RST** 当RST=1时，表明TCP连接中出现严重的差错，必须释放连接，然后再重新连接。RST置1还用来拒绝一个非法的报文段和拒绝打开一个连接.RST也称为重连或重置位
10. **同步SYN**。 在连接建立时用来同步序号。当SYN=1而ACK=0时，表明这是一个连接请求报文段。对方同意建立连接，则在相应的报文段中使用SYN=1和ACK=1，因此，SYN置为1就表示这是个连接请求或连接解释报文。
11. **终止FIN** 用来释放一个连接，当FIN=1时，表明此报文的发送发的数据已发送完成。并要求释放运输连接
12. **窗口 占2个字节**，窗口值是[0,2^16-1].窗口指的是发送本报文段的一方接收窗口。窗口值作为接收方让发送方设置其发送窗口的依据。根据接收方接收缓存区剩余容量大小来指定
13. **检验和**。占2个字节，检验和字段检验的范围包括首部和数据这两部分。
14. **紧急指针**。占2个字节。紧急指针在URG=1时才用意义。它指出本报文中紧急数据的字节数（紧急数据结束后就是普通数据）。即使窗口为0也可以发送紧急数据
15. **选项** 长度可变，最长可达40字节。没有选项时，TCP首部20字节



